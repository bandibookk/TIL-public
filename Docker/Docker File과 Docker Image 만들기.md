# 도커 이미지 만들기
도커 컨테이너는 도커 이미지를 통해 만들어진다. 도커 이미지는 도커 허브에서 다운 받아 사용하는데, 내가 직접 만들 수도 있다. <br>
이런 도커 이미지를 만들기 위해선 Docker File이 필요하다. <br>

![docker file](https://user-images.githubusercontent.com/71186266/210362407-b6cc2901-3471-4ea1-a1eb-65a8ea5d6331.png)


이 Docker File을 도커 클라이언트를 통해 도커 서버가 인식하도록 만들어 주면 도커 이미지가 생성된다. <br> 
위의 그림과 같이 도커 파일을 Build하면 도커 이미지가 되고, 도커 이미지를 RUN 하면 도커 컨테이너가 된다. <br>
이번 글에서는 Docker File을 만들고, 도커 파일로 이미지를 만드는 법에 대해 설명하겠다. + 내가 만든 이미지에 기억하기 쉬운 이름을 주는 법을 알아보겠다. 

## 1. Docker File
**Docker File은 Docker Image를 위한 설정 파일로, 컨테이너가 어떻게 행동해야 하는지에 대한 설정들을 정의해 놓은 파일 이다.** <br>

도커 파일을 만들기 전에 도커 이미지에게 필요한 것들을 생각해 보자. <br>
기본적으로 우리가 알고 있는 것은 **실행 명령어와 파일 스냅샷이다.** <br>
그래서 도커 파일에는 아래와 같은 요소들이 필요하다.
1. 컨테이너 시작시 실행 될 명령어
2. **Base Image** 명시 (파일 스냅샷)
3. 추가적으로 필요한 파일 다운을 위한 명령어 (파일 스냅샷)

### Base Image?
베이스 이미지란 무엇일까. 도커 이미지는 여러 층의 레이어로 구성 되어 있다고 설명했다. 사실은 순수하게 전부 레이어로만 구성되어 있지는 않고, **베이스 이미지라는 이미지 위에 레이어들이 쌓여있는 방식으로 구성 되어 있다.** 베이스 이미지는 이미지의 기반이 되는 이미지이다. <br>
비어 있는 첫 Layer와 같은 느낌으로, 이 안에 자유롭게 기반이 되는 이미지들을 설정해줄 수 있다.

<!-- 강의에서는 운영체제라고 생각하면 된다고 설명했는데 이 설명이 와닿지는 않는다. 아마도 베이스 이미지로서 OS의 이미지를 설정해줄 수 있는데,  -->

## 2. Docker File 만들기
Docker File을 만드는 법을 알아보자. <br>
Docker File은 `Dockerfile`이라는 이름으로 확장자 없는 파일을 만들어 주면 된다. <br>
이후 파일 내부를 아래와 같이 구성한다.
```dockerfile
# 베이스 이미지 - 이미지 생성의 기반이 되는 레이어
FROM baseImage

# 도커 이미지가 생성되기 전에 수행 될 쉘 명령어
RUN command

# 컨테이너가 시작되었을 때 실행할 파일 또는 쉘 스크립트
CMD ["executable"]
```
1. `FROM`: **베이스 이미지를 명시하기 위한 명령어이다.** 여기에 `이미지: 태그`형식으로 기입해주면, Base Image가 되는데, 태그를 안 붙이면 최신 버전이 다운 받아진다. <br> ex) `ubuntu:14.04` 와 같이 작성하면 우분투 14.04 버전이 베이스 이미지가 되는 것이다.
2. `RUN`: 추가적으로 필요한 파일들을 다운 받기 위한 부분으로, 도커 이미지가 생성되기 전에 해당 쉘 명령어가 수행된다.
3. `CMD`: 컨테이너가 시작될 때 실행할 실행 파일 또는 쉘 스크립트를 명시하는 곳이다. 해당 명령어는 Docker File에서 단 한번만 쓸 수 있다.

## 3. Dokcer File로 Image 만들기
도커 파일에 입력된 내용들을 도커 서버가 인식하게 만들어 줌으로써 도커 이미지를 만들 수 있다. <Br> 
도커 클라이언트를 통해 도커 파일이 도커 서버에 연결되어 도커 파일을 인식하게 만들어 줄 수 있다. <br>
### `docker build ./` 
이런 파일 인식은 `docker build ./` 나 `docker build .`의 명령어로 가능한데, 전자를 권한다. <Br> 
**위 명령어는 지정된 디렉토리에서 dockerfile이라는 이름으로 되어 있는 파일을 찾아 도커 클라이언트에게 전달 시켜준다.** 


위와 같이 명령어를 입력하면, 도커 파일을 클라이언트를 통해 도커 서버에 인식시켜 이미지를 만들수 있게 된다!

### 도커 파일을 이미지로 만드는 과정
도커는 **임시 컨테이너를 통해** 도커 파일을 도커 이미지로 만들어 준다. <br>
도커 이미지가 만들어지는 과정은 아래와 같다.
1. 도커 파일의 베이스 이미지를 가져온다. 
2. **임시 컨테이너를 만들어 베이스 이미지의 파일 스냅샷을 적재한다.**
3. 이후 `RUN` 등의 명령어로 추가적으로 필요한 내용들을 전부 이 임시 컨테이너의 스냅샷 부분에 넣어준다. 
4. 그러면 이 임시 컨테이너의 시작시 실행 명령어 부분은 비어 있게 되는데, **이 부분엔 도커 파일 내의 시작시 실행 명령어를 넣어준다. (CMD)**
5. 이 **임시 컨테이너를 통해 이미지를 만든다! 이미지의 id는 이 임시 컨테이너의 id이다!**

위의 과정을 통해 도커 파일이 도커 이미지로 만들어지게 된다. 결국 도커 파일로 이미지를 만드는 방법은, **임시 컨테이너를 만들어서 그 안에 필요한 내용들을 전부 넣어 주고, 그 컨테이너를 이미지로 만들어 주는 것이다.**

## 4. 도커 이미지에 이름 지어주기
### `-t [도커 아이디]/[저장소/프로젝트 이름]:[버전]` 

위와 같은 명령어로 도커 이미지에 이름을 지어줄 수 있다! <Br>

위의 내용을 설명할 겸 실제로 간단하게 도커 파일과, 이미지를 만들어 보자!

## 5. 직접 만들어 보기
간단하게 `Hello! Jinho!`라는 문구를 출력하는 도커 파일과 이미지를 만들어 보겠다. <br>
아래와 같은 스크립트를 작성해 보았다. 
```dockerfile
FROM alpine
# RUN 필요 없어서 주석 처리
CMD ["echo", "Hello! Jinho!"]
```
예시를 위해 베이스 이미지는 가벼운 alpine으로 해 주었다. <br>

그리고, `docker build ./` 명령어를 통해 이미지를 생성해보자. 

![docker file build](https://user-images.githubusercontent.com/71186266/210371061-b983b67c-0175-40f3-90b8-db00d2682e0d.png)

그림과 같이 성공적으로 이미지가 만들어 졌다. Hello! Jinho! 또한 성공적으로 출력 되었다. <br>

Nameing을 위한 `-t` 옵션이 추가된 build 명령어를 수행해보자. <br>
`docker build -t binaryhoho/hello:latest ./` 


![docker build nameing option](https://user-images.githubusercontent.com/71186266/210371055-a98c49a1-a864-46a8-b703-c7fe93ef3869.png)

윗 부분에 `-t` 옵션이 추가된 명령의 실행이 있고, 아래 부분은 이름으로 직접 만든 이미지를 실행한 모습이다! <br>
성공적으로 Hello! Jinho!가 호출 되었다! 

## Reference
- [따라하며 배우는 도커와 CI환경](https://www.inflearn.com/course/%EB%94%B0%EB%9D%BC%ED%95%98%EB%A9%B0-%EB%B0%B0%EC%9A%B0%EB%8A%94-%EB%8F%84%EC%BB%A4-ci/dashboard)
