# 앱 소스 코드 변경 반영 최적화
```dockerfile
FROM node:10
WORKDIR /usr/src/app
COPY ./ ./
RUN npm install
CMD ["node", "server.js"]
```
기본적으로 위와 같은 코드로 만들어진 이미지를 사용하겠다.

## 재빌드.. 그기 돈이 됩니까?
이제까지는 어플리케이션 소스나 변경시 반영을 위해 이미지를 새로 생성하고 컨테이너를 생성한 뒤 앱을 실행 시켰다. <br>
우리가 도커파일을 짤 때 `COPY` 명령어를 이용해 소스 파일을 복사해 주었다. 따라서, 그런데 이 소스파일이 변경 되었으므로, 도커파일 자체를 다시 이미지로 만들어 줘야 하는 것이다. <br>
이런 부분들은 당연히 효율적이라고 할 수 없다. 계속해서 용량이 큰 이미지를 다시 만들고, 또 다시 컨테이너를 생성시켜줘야 하기 때문이다. <br>
이런 소스 코드의 변경에 대한 최적화 방법을 알아보겠다.


## 1. 종속성 관련 코드 따로 빼기
사실 소스코드 조금 변경되었다고, 다 다시 받아야 할까? <br>
그리고 소스코드들이 용량이 크면 얼마나 클까? <br>
프로젝트를 다시 전부 다운로드 받을 때 문제가 되는 부분들은 여러 부분이 있지만, 아무래도 **무거운 종속성 파일들의 다운로드가 문제가 된다.** <br>

그리고 도커 이미지 빌드를 연속으로 두 번 해보면 볼 수 있는 알림문구들에 의하면, 캐시에 이미 있는 데이터들은 굳이 다시 만들지 않고 캐시를 사용한다. <br>

따라서 아래와 같은 종속성 파일을 포함한 COPY 명령어는 변경될 필요가 있다. <br>

```
COPY ./ ./
RUN npm install
```
에서, npm install이 영향을 미치는 `package.json`만 따로 뺀다.

```
COPY package.json ./

RUN npm install

COPY ./ ./ 
```

이런 식으로 바꿔주면, 종속성 변경이 없는 경우 굳이 전부 다운받지 않아서 좀 더 효율적인 재빌드가 된다. <br>

### 결론
요는 꼭 종속성 파일을 빼라는 것이 아니라, 무겁고 변경이 적은 부분은 이렇게 따로 처리하라는 것이다. 주로 종속성 관련 명령어가 될 것이다. 


## 2. Docker Volume
종속성 코드를 빼 주어서 이제 쓸대없이 모듈 전체를 다시 다운 받는 일은 사라졌다. <br>
하지만 소스코드의 변경을 반영하기 위해 다시 소스 코드 부분을 COPY 하고, 이미지를 다시 빌드하고, 컨테이너를 다시 띄워주는 과정은! 여전히 참 번거롭고 시간이 아깝다. <br>
이런 문제를 해결하기 위해 등장한 것이 Docker Volume이다.


### 복사가 아닌 Mapping
Docker Volume은 기존 방식과 같이 힘들게 복사를 하는 것이 아니라, 도커 컨테이너에서 로컬의 파일들을 직접 참조하도록 한다. <br>

이미지가 가지고 있는 소스 코드의 내용들을 컨테이너로 힘들게 복사 해오는 것이 아니라, 그저 참조하는 것이다! <br>

아래와 같은 코드로 실행 가능하다.

```
docker run -p 5000:8080 -v /usr/src/app/node_modules -v %cd%:/usr/src/app <이미지 아이디>
```
이제까지 배운 내용과 합쳐진 버전으로, `-v /usr/src/app/node_modules` 부분과, `-v %cd%:/usr/src/app` 부분이 추가 된 것이다.
(위 코드는 윈도우 버전이다. 맥의 경우 pwd 부분을 `-v $(pwd):/usr/src/app`로 변경한다.) <br>

각 부분을 소개하겠다. 

### `-v /usr/src/app/node_modules`
위 코드는 이미지의 호스트 디렉토리에 없는 요소들을 매핑(참조)하지 말라는 명령어이다. <br>
우리가 예시로 사용한 이미지 파일은 직접 모듈들을 들고 있지 않다. 컨테이너 안에서 `npm install` 명령어를 통해 설치하기 때문에, 의존성 파일은 컨테이너가 가지고 있다. <Br>
때문에 잘못하고 컨테이너가 이미지를 뒤적거리는 일을 막기 위해 위의 명령어를 통해 이미지에서 참조할 내용이 없음을 알리는 것이다. <Br>

## `-v %cd%:/usr/src/app`
위 명령어는 현재 경로에 있는 디렉토리 혹은 파일들을 `/usr/src/app`경로에서 참조 하라는 명령어이다. <br>
윈도우의 경우 `cd`명령어로. MAC OS의 경우 print working directory 명령어 `pwd`를 이용한다. <Br> 

두 부분의 추가로, 소스코드는 매핑하고, 의존성 파일은 직접 만들 수 있게 되는 것이다.

## Reference
- [따라하며 배우는 도커와 CI 환경](https://www.inflearn.com/course/%EB%94%B0%EB%9D%BC%ED%95%98%EB%A9%B0-%EB%B0%B0%EC%9A%B0%EB%8A%94-%EB%8F%84%EC%BB%A4-ci/dashboard)
