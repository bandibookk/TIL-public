### 17.3 Update Lock
## 17.3.1 Lock Upgrade, Downgrading

트랜잭션은 어떤 데이터 객체에 대해 얻은 Lock을 변환할 수 있다. <Br> 
Shared Lock을 Exclusive Lock으로 변환하는 행위를 Lock Upgrade - 잠금 강도 강화라고 부르고, Exclusive Lock을 Shared Lock으로 변환하는 행위를 Lock Downgrading - 잠금 강도 약화라고 부른다. <Br>

## Lock Upgrade - 잠금 강도 강화
SQL Update 문장은 테이블의 각 행에 Shared Lock을 설정해 그 행이 WHERE 조건에 맞는지 확인한다. <br>
그리고 WHERE 조건을 만족한다면 그 행에 대하여 Exclusive Lock을 걸어 값을 `WRITE` 한다. <Br>

이러한 Lock Upgrade는 다른 트랜잭션들이 해당 객체에 대해 Shared Lock을 소유하고 있지 않다면 즉시 진행된다. <Br>
그렇지 않다면, **큐의 앞 부분에 Upgrade 요구가 삽입된다.** <br>

왜 앞 부분에 삽입되는걸까? **만약 위 객체에 대해 Exclusive Lock을 요청하는 트랜잭션이 이미 큐에 있다면, 현재 Shared Lock을 소유중이기 떄문에 Exclusive Lock 요청은 계속 대기되면서 데드락이 발생할 수 있다.** <br>

아쉽게도 이런 방식으로도 Deadlock은 발생할 수 있는데, 만약 Shared Lock을 가진 두 트랜잭션이 모두 Lock Upgrade을 요구한다면 교착상태가 발생할 수 있다.

## Lock Downgrading - 잠금 강도 약화
더 나은 방법이 있다 <br>
**애초에 Exclusive Lock을 주고, Exclusive Lock이 필요 없을 때 Shared Lock으로 Downgrading 시키는 것이다.** <br>
이렇게 하면 Lock Upgrade에 대한 필요성을 피할 수가 있다. <br>
위에서 예시를 들은 Update 쿼리를 생각해보자. 테이블에 있는 행들을 먼저 Exclusive Lock으로 잠금해버리고, **WHERE 조건을 만족하지 못하는 각 행들을 Shared Lock으로 Downgrading 시키는 것이다.** <br> <br>

### 잠금 강도 약화는 2PL 요구조건을 위반하는가?
표면산으로는 2PL 요구조건을 위반하는 것으로 보일 수도 있다. <br>
어떤 트랜잭션이 소유한 잠금 권한을 줄이고, 다른 잠금을 요구하며 진행될 수 있기 떄문이다. <br>
그러나, 이는 좀 특별한 경우인데 Exclusive Lock을 얻고도, 실제로는 값을 수정하지 않고 읽기만 했기 떄문이다. <br> 
트랜잭션이 아직 객체를 수정하지 않았더라면, Lock을 얻는 단계에서 Lock 약화를 허락하도록 해줌으로써 2PL의 정의를 안전하게 확장할 수 있다. 


## 17.3.2 Update Lock

Lock Downgrading은 Write를 실제로 하지 않을거면서 Exclusive Lock을 얻음으로서, 동시성을 저하시킨다. <Br>
그러나 대체로 DeadLock을 줄임 수 있기 때문에 전체 성능을 향상시킨다. 이런 Downgrading은 상업용 시스템에서 폭넓게 사용되고 있다고 한다. <br> <Br>

동시성은 `Update Lock`이라고 하는 새로운 종류의 Lock의 도입으로 향상될 수 있다. <br>
Update Lock은 Shared Lock과 양립 가능하지만, Exclusive Lock이나 또다른 Update Lock과는 양립할 수 없다. <Br>

이러한 Update Lock은 Shared Lock과 Exclusive Lock의 중간 단계처럼 여길 수 있는데, <br> 

일단 Update Lock을 설정해둔 다음 (Exclusive Lock과 양립 방지) 데이터 객체가 갱신할 필요가 없다는 것이 확실해지면 Shared Lock으로 Lock을 Downgrading 하고, 갱신할 필요가 있다면 Exclusive Lock으로 잠금을 강화한다. <br>
이러한 Lock Upgrade는 어떤 다른 트랜잭션이 객체에 Exclusive Lock을 가질 수 없기 때문에 Deadlock에 빠지지 않게 된다. 


## Reference
- Database Management Systems <Raghu Ramkrishnan 저>
