# DataBase 다중화 문제 1 [윤영 교수님 특별 수업]

이번 22년 10월 말, 카카오 데이터 센터에 화재가 나는 사건이 발생하였다. 아쉽게도, 카카오에선 데이터 이중화 작업을 해두지 않아, 꽤 긴 시간의 장애가 발생하였다. <br> 우리나라에서 카카오의 영향력은 무지막지하다. 과장을 보태면 한국인에게 카카오톡은 공기와도 같은 존재일 것이다. 그렇기에 이번 사태는 정말 엄청난 이슈가 되었다. 피해를 본 사람도 많았지만, 일단은 서비스기에 불편을 느낀 사람이 정말 많았다는 것 자체가 큰 문제였다. <br> <br> 

나는 개인적으로 카카오의 큰 팬이고, 이번 사태에는 네이버 데이터센터 사건과 같은 문제들이 원인으로 작용했다고 옹호하고 있지만, 여론은 정말 좋지 않다. 개발에 대해 연이 있는 사람도 없는 사람도 이중화와 분산에 대해 이야기하고, 비판에 나선다. 역시나 주가 또한 폭락했다. (나는 이 때다 싶어서 매수 계획을 잡고 있다.) <br> <br> 

이에 윤영 교수님께서는 중간고사도 끝난 겸, 큰 사건도 터진 겸 이중화에 관한 이야기를 나누어 보자고 하셨다. 원인 분석 보다는 데이터 이중화나 분산에 대한 이야기를 하셨다. 

## 1. DB와 서버의 다중화
데이터 베이스가 여러개면 왜 좋을까? 다시 말하면, 같은 데이터가 저장된 데이터베이스를 2개 이상 운용할 수 있다면 어떤 점이 좋을까? <br> 일단 하나의 데이터베이스가 치명적인 손상을 입었을 때 좋을 것이다. 기존에 제공하던 서비스와 같은 서비스를 제공하려면, 당연히 장애가 발생하기 전의 데이터가 그대로 필요하다. <br> 또 서버의 분산도 가능하다. 외국에서 찍어 올린 유튜브 영상도 우리 나라에 서버가 있다면 빠르게 볼 수 있다, 그리고 DB또한 같다. 그 밖에 막대한 트래픽을 견뎌내기 위해 트래픽을 분산시킬 수도 있겠다. <br>
<Br>

이중화가 이렇게 좋은데.. 한 가지 문제점이 있다... **두 DB가 항상 같은 내용을 가지고 있다는건 어떻게 보장할 것인가?**

## 2. 다중화 문제

DB를 다중화한다는 것은 같은 데이터를 가진 DB를 여러개 두겠다는 것이다. 다른 데이터를 가지고 있으면, 위에서 말하는 장점들을 누리지 못 한다. 멀리 떨어진 곳에서도 정확히 같은 서비스를 제공하려면 **두 DB에 저장된 데이터는 항상 같아야한다.** <br> 나에게 1억원이 있는 계좌가 있다. 한국에 있는 계좌에서 내가 1억원을 꺼내는 동시에, 미국에 사는 아내에게 1억원을 꺼내달라고 부탁했다. 만약, DB가 항상 같지 않다면 우리 부부는 1억원이 있는 계좌에서 2억원을 꺼내어 버릴 수 있다. 이걸 반복해서 돈을 무한히 복사한다면 은행은 망할 것이다.. <br>

이는 OS에서 벌어지는 문제와 아주 비슷하다. OS의 용어를 쓰자면,  공유 Resource에 대해 Race Condition이 발생한 것이다. 이를 확실히 하려면 어떻게 해야할까? 두 DB에 동시에 트랜젝션을 걸 수도 없고, 결국 정확한 시간을 알아내어

# 3. 시간의 문제
어떤 공유 리소스로의 정확한 접근 시간을 알면, Race Condition을 막을 수 있지 않을까? <br>
괜찮은 아이디어이다. 하지만 **시간을 파악한다는건 생각보다 아주 어려운 일이다.** <br>
서버 시간은 신뢰할 수 있는 시간인가? 아주 멀리 떨어진 두 서버의 시간은 정확히 일치하는가? 아니다. <br> 
GPS를 달면? 서버는 보통 실내에 있기에, 인공위성과 교신하기 좋은 상황은 아니다. <br>
그러면 시간을 따로 관리하는 time server를 두고, 다들 이 서버 시간을 공유해서 쓰면 되지 않을까? 좋은 생각이다, 그런데 **네트워크는 결국 딜레이가 있다.** <br>

![time](https://user-images.githubusercontent.com/71186266/199968611-4b31d298-339f-44f9-a915-4424f4764cb2.png)
왼쪽이 DB, 오른쪽이 타임서버 쪽이다. <br>
t1에서 시간을 확인하기 위해 요청을 보내면 결국, 위의 그림에서 처럼 필연적으로 딜레이가 발생한다. 실제로 내가 알고 싶은 시간은 `t1 - δ1`인 이므로, `δ1`에 해당하는 딜레이가 발생한 것이다.. <br>
그럼 우리가 δ1과 δ2 둘 다 알 수 없는 상황이라면, 어떻게 정확한 현재 시간을 파악할 수 있을까?  <br>

![time2](https://user-images.githubusercontent.com/71186266/199969480-10902a04-c4cf-4a78-a33e-f5db924fc62e.png)
바로 위와 같이 **전송시 딜레이와 송신시 딜레이가 같다는** 느슨한 가정을 통해 딜레이를 알아낼 수 있다. 자체적인 타이머로 Round Trip Time을 측정한 다음 `RTT/2`를 받은 시간에서 빼주면, 실제 시간 t1을 구할 수 있다. `t = ts - RTT/2` <br> 
 
### 렘포트 클락
이런 다양한 해결법에 더해, 레슬리 렘포트는 상대적인 시간으로 시간을 파악하지는 아이디어를 도입했다. 절대시간으로 파악하려니 너무 많은 문제가 있었기에, 상대 시간의 도입은 많은 좋은 영향을 가져왔다.

