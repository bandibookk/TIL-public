# 3.4 [중요] Page Replacement Algorithm
## 6. Least Recently Used
**Least Recently Used 알고리즘은 가장 최근에 사용된 page가 곧 다시 사용될 것이라고 생각한다**. <br>
**이에, 가장 예전에 사용한 page를 out하는 알고리즘이다!** <br>

## 6.1 LRU의 하드웨어 적인 실행

LRU를 리스트로 구현하면, 모든 메모리 참조마다 리스트를 생긴해야해서 비용이 너무나도 크기 때문에, 다른 방법을 사용한다. <br>

### 6.1.1 카운터 이용
C라는 64-bit 카운터를 이용한다. 이 카운터는 명령어가 실행될 때마다 1씩 증가한다. 이 카운터는 각 페이지 테이블 엔트리에 저장된다. <br>
Page fault가 발생하면 OS는 모든 page table entry의 C값을 조사해서 가장 적은 값을 갖는 페이지를 교체한다. <br> 
**이 페이지가 바로 Least Recently Used Page다.** <br>

### 6.1.2 Matrix 사용
**시스템이 n개의 page frame을 가지고 있다면, LRU 하드웨어는 n*n 비트로 구성된 행렬을 갖는다!**  <br>

![lru matrix](https://user-images.githubusercontent.com/71186266/206855163-10a6e296-f346-4c64-bd42-ecfb534813fb.png)


page frame k가 참조되는 경우, 알고리즘의 진행은 다음과 같다.
1. 행렬의 k번째 행의 모든 비트값을 1
2. 행렬의 k번째 열의 모든 비트값을 0
3. **행의 값들의 합이 작을 수록 과거에 참조된 page frame이다.**
 
아래의 예시는
`0 1 2 3 2 1 0 3 2` 순서로 참조되었다. 0이 참조된 이후가 (a)이다.


직접 확인해보자.

## 6.2 LRU의 소프트웨어 실행
실제로 위에서 언급한 하드웨어가 제공되는 시스템은 거의 없고, 소프트웨어적인 실행이 더 많이 연구되었다. <br>

이에 R횟수를 세는 Not Frequently Used 알고리즘이 제안되었다. <br>

### 6.2.1 Not Frequently Used
NFU 알고리즘
1. 각 페이지마다 소프트웨어 카운터를 유지함
2. 클록 인터럽트 마다 R비트의 값을 카운터에 더한다.
3. page fault시 카운터 값이 가장 적은 페이지가 out된다.


중간에 counter가 reset될 수가 없는 것이 단점이다. <br>

### 6.2.2 Aging - NFU의 변형
NFU를 변형하면 LRU와 비슷한 성능을 얻을 수 있다. <br>


![lru aging](https://user-images.githubusercontent.com/71186266/206855161-105103d6-c1f7-4a28-832b-986a449f0de4.png)


변경은 두 부분으로 구성된다. 
1. 카운터에 R 비트 값을 더하기 전에 **오른쪽으로 1 비트 시프트 한다.**
2. R Bit는 오른쪽 비트가 아닌 왼쪽 최상위 비트에 추가된다.


이를 Aging이라고 부르고 아래와 같이 동작한다. <br>


최근에 불린 횟수가 적을 수록 카운터 값이 작을 수 밖에 없다. **카운터 값이 작을 수록 우선적으로 교체된다.** <br>

### 6.2.3 Aging과 LRU의 차이
1. **Aging은 한 클록 틱 안에서 어떤 페이지가 먼저 호출되었는지 알 수 없다.** <br> 단지 한 클록틱 안에서 호출 되었느냐만 세기 때문이다. <br> 만약 위의 그림에서 페이지 3, 5에 대해 c에서 둘의 호출이 있었을 때, 5가 먼저 호출되고 3이 번저 호출되었다고 해보자. <br> LRU에 따르면 더 오래된 5가 퇴출 되어야 하나, Aging에서는 5의 값이 더 높으므로, 3이 먼저 퇴출된다.
2. 저장되는 기록이 제한적이다. 예를 들어서 지금 8bit를 통해 기록중인데 8회차를 넘어가는 기록은 전부 말소되기 때문에, 여기서도 제대로 된 LRU를 따르지 않는 page out의 발생 가능성이 있다.



## Reference
- Modern Operating Systems <ANDRWE S. TANENBAUM 저>
 
